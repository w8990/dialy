# 交友社区应用开发文档 v1.0

## 项目概述

基于 uni-app x 框架开发的跨端交友社区应用，支持 iOS、Android、H5、微信小程序多端一致体验。

### 技术栈
- **前端**: uni-app x + Vue 3 + TypeScript
- **后端**: uniCloud + Node.js
- **数据库**: MySQL (阿里云)
- **存储**: 阿里云 OSS
- **即时通讯**: WebSocket / IM SDK

## 开发计划

### MVP 阶段 (P0) - 4-6周
1. **用户认证系统**
   - 手机号+短信验证码登录
   - 微信登录集成
   - Apple ID 登录 (iOS)
   - 基础资料设置

2. **动态发布系统**
   - 图文动态发布
   - 短视频发布 (≤60s)
   - 语音动态 (≤60s)
   - 话题标签系统
   - 可选定位功能

3. **广场与关注流**
   - 广场时间线 (推荐/最新)
   - 关注用户动态流
   - 点赞、评论、@功能
   - 表情系统

4. **社交关系**
   - 关注/取关功能
   - 好友动态页面

5. **私信系统**
   - 单聊功能 (文本/表情/图片)
   - WebSocket 实时通讯

6. **通知中心**
   - 点赞、评论、关注、私信通知
   - 系统通知

7. **隐私与安全**
   - 动态可见范围设置
   - 举报/拉黑功能
   - 基础内容审核

### V1.1 阶段 (P1) - 3-4周
- 热门话题榜
- 附近的人
- 兴趣推荐
- 转发功能
- Push 通知

### V1.2 阶段 (P2) - 按需开发
- 推荐算法优化
- 运营工具
- A/B 测试平台

## 技术架构设计

### 前端架构

```
/src
├── pages/                 # 页面目录
│   ├── index/             # 首页 (广场)
│   ├── discover/          # 发现页
│   ├── publish/           # 发布页
│   ├── message/           # 消息页
│   ├── profile/           # 个人主页
│   ├── auth/              # 认证相关页面
│   ├── post/              # 动态详情页
│   └── settings/          # 设置页面
├── components/            # 公共组件
│   ├── PostCard/          # 动态卡片
│   ├── UserCard/          # 用户卡片
│   ├── CommentList/       # 评论列表
│   ├── MediaUploader/     # 媒体上传器
│   └── NavBar/            # 导航栏
├── utils/                 # 工具函数
│   ├── request.uts        # 网络请求封装
│   ├── auth.uts          # 认证工具
│   ├── storage.uts       # 本地存储
│   ├── media.uts         # 媒体处理
│   └── constants.uts     # 常量定义
├── store/                 # 状态管理
│   ├── user.uts          # 用户状态
│   ├── posts.uts         # 动态状态
│   └── messages.uts      # 消息状态
└── assets/                # 静态资源
    ├── images/           # 图片资源
    └── icons/            # 图标资源
```

### 数据模型设计

#### 用户相关表

```sql
-- 用户基础表
CREATE TABLE users (
    uid VARCHAR(32) PRIMARY KEY,
    phone VARCHAR(20) UNIQUE,
    wechat_openid VARCHAR(50),
    apple_sub VARCHAR(100),
    status TINYINT DEFAULT 1, -- 1:正常 2:封禁
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    device_fingerprint VARCHAR(100),
    INDEX idx_phone (phone),
    INDEX idx_wechat (wechat_openid)
);

-- 用户资料表
CREATE TABLE profiles (
    uid VARCHAR(32) PRIMARY KEY,
    avatar_url VARCHAR(500),
    nickname VARCHAR(50) NOT NULL,
    gender TINYINT, -- 1:男 2:女 0:未设置
    signature VARCHAR(200),
    interests JSON, -- 兴趣标签数组
    privacy_settings JSON, -- 隐私设置
    location_preference JSON, -- 地理偏好
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (uid) REFERENCES users(uid)
);
```

#### 动态相关表

```sql
-- 动态表
CREATE TABLE posts (
    post_id VARCHAR(32) PRIMARY KEY,
    uid VARCHAR(32) NOT NULL,
    content TEXT,
    media JSON, -- 媒体文件信息数组
    topics JSON, -- 话题标签数组
    location_info JSON, -- 位置信息
    visibility TINYINT DEFAULT 1, -- 1:公开 2:好友 3:仅自己
    status TINYINT DEFAULT 1, -- 1:已发布 2:审核中 3:已删除
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    repost_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_uid_time (uid, created_at),
    INDEX idx_status_time (status, created_at),
    INDEX idx_location (location_info),
    FOREIGN KEY (uid) REFERENCES users(uid)
);

-- 评论表
CREATE TABLE comments (
    comment_id VARCHAR(32) PRIMARY KEY,
    post_id VARCHAR(32) NOT NULL,
    uid VARCHAR(32) NOT NULL,
    reply_to_id VARCHAR(32), -- 回复的评论ID
    reply_to_uid VARCHAR(32), -- 回复的用户ID
    content TEXT NOT NULL,
    status TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_post_time (post_id, created_at),
    INDEX idx_user (uid),
    FOREIGN KEY (post_id) REFERENCES posts(post_id),
    FOREIGN KEY (uid) REFERENCES users(uid)
);
```

#### 社交关系表

```sql
-- 关注关系表
CREATE TABLE follows (
    follower_uid VARCHAR(32),
    followee_uid VARCHAR(32),
    status TINYINT DEFAULT 1, -- 1:关注中 2:已取消
    is_mutual TINYINT DEFAULT 0, -- 是否互关
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (follower_uid, followee_uid),
    INDEX idx_follower (follower_uid),
    INDEX idx_followee (followee_uid),
    FOREIGN KEY (follower_uid) REFERENCES users(uid),
    FOREIGN KEY (followee_uid) REFERENCES users(uid)
);

-- 拉黑关系表
CREATE TABLE blocks (
    blocker_uid VARCHAR(32),
    blocked_uid VARCHAR(32),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (blocker_uid, blocked_uid),
    FOREIGN KEY (blocker_uid) REFERENCES users(uid),
    FOREIGN KEY (blocked_uid) REFERENCES users(uid)
);
```

#### 消息相关表

```sql
-- 会话表
CREATE TABLE conversations (
    conv_id VARCHAR(32) PRIMARY KEY,
    type TINYINT DEFAULT 1, -- 1:单聊 2:群聊
    participants JSON, -- 参与者UID数组
    last_message_id VARCHAR(32),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_participants (participants)
);

-- 消息表
CREATE TABLE messages (
    message_id VARCHAR(32) PRIMARY KEY,
    conv_id VARCHAR(32) NOT NULL,
    sender_uid VARCHAR(32) NOT NULL,
    message_type TINYINT, -- 1:文本 2:图片 3:语音 4:表情
    content TEXT,
    media_url VARCHAR(500),
    read_status JSON, -- 各用户读取状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_conv_time (conv_id, created_at),
    INDEX idx_sender (sender_uid),
    FOREIGN KEY (conv_id) REFERENCES conversations(conv_id),
    FOREIGN KEY (sender_uid) REFERENCES users(uid)
);
```

#### 通知相关表

```sql
-- 通知表
CREATE TABLE notifications (
    notification_id VARCHAR(32) PRIMARY KEY,
    recipient_uid VARCHAR(32) NOT NULL,
    type TINYINT NOT NULL, -- 1:点赞 2:评论 3:关注 4:私信 5:系统
    actor_uid VARCHAR(32), -- 操作者UID
    target_type TINYINT, -- 目标类型 1:动态 2:评论 3:用户
    target_id VARCHAR(32), -- 目标ID
    content TEXT,
    is_read TINYINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_recipient_read (recipient_uid, is_read),
    INDEX idx_recipient_time (recipient_uid, created_at),
    FOREIGN KEY (recipient_uid) REFERENCES users(uid)
);
```

### API 接口设计

#### 认证相关接口

```typescript
// 发送验证码
POST /api/auth/send-code
{
  phone: string,
  captcha?: string
}

// 短信登录
POST /api/auth/login-sms
{
  phone: string,
  code: string
}

// 微信登录
POST /api/auth/login-wechat
{
  code: string,
  platform: 'app' | 'mp' | 'h5'
}

// Apple登录
POST /api/auth/login-apple
{
  identityToken: string,
  authorizationCode: string
}

// 刷新Token
POST /api/auth/refresh
{
  refreshToken: string
}

// 登出
POST /api/auth/logout
```

#### 用户相关接口

```typescript
// 获取当前用户信息
GET /api/me

// 更新用户资料
PATCH /api/me/profile
{
  nickname?: string,
  avatar?: string,
  signature?: string,
  interests?: string[],
  privacy?: object
}

// 获取用户信息
GET /api/users/:uid

// 关注用户
POST /api/users/:uid/follow

// 取消关注
DELETE /api/users/:uid/follow

// 拉黑用户
POST /api/users/:uid/block

// 取消拉黑
DELETE /api/users/:uid/block
```

#### 动态相关接口

```typescript
// 发布动态
POST /api/posts
{
  content: string,
  media?: Array<{type: string, url: string}>,
  topics?: string[],
  location?: object,
  visibility?: number
}

// 获取动态详情
GET /api/posts/:postId

// 删除动态
DELETE /api/posts/:postId

// 点赞动态
POST /api/posts/:postId/like

// 取消点赞
DELETE /api/posts/:postId/like

// 获取广场时间线
GET /api/feed/public?tab=recommend|latest&page=1&size=20

// 获取关注动态流
GET /api/feed/following?page=1&size=20

// 获取附近的人
GET /api/feed/nearby?radius=10&page=1&size=20
```

#### 评论相关接口

```typescript
// 获取动态评论
GET /api/posts/:postId/comments?page=1&size=20

// 发表评论
POST /api/comments
{
  postId: string,
  content: string,
  replyToId?: string,
  replyToUid?: string
}

// 删除评论
DELETE /api/comments/:commentId
```

#### 私信相关接口

```typescript
// 获取会话列表
GET /api/conversations?page=1&size=20

// 创建会话
POST /api/conversations
{
  participantUid: string
}

// 获取消息列表
GET /api/messages?convId=xxx&page=1&size=50

// 发送消息
POST /api/messages
{
  convId: string,
  type: number,
  content?: string,
  mediaUrl?: string
}

// 标记消息已读
POST /api/messages/read
{
  convId: string,
  messageId: string
}
```

### 页面结构设计

#### pages.json 配置

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "广场"
      }
    },
    {
      "path": "pages/discover/discover", 
      "style": {
        "navigationBarTitleText": "发现"
      }
    },
    {
      "path": "pages/publish/publish",
      "style": {
        "navigationBarTitleText": "发布动态"
      }
    },
    {
      "path": "pages/message/message",
      "style": {
        "navigationBarTitleText": "消息"
      }
    },
    {
      "path": "pages/profile/profile",
      "style": {
        "navigationBarTitleText": "我的"
      }
    }
  ],
  "subPackages": [
    {
      "root": "pages/auth",
      "pages": [
        {
          "path": "login/login",
          "style": {
            "navigationBarTitleText": "登录"
          }
        },
        {
          "path": "register/register", 
          "style": {
            "navigationBarTitleText": "注册"
          }
        }
      ]
    }
  ],
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#007AFF",
    "backgroundColor": "#FFFFFF",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/index/index",
        "iconPath": "static/tab-icons/home.png",
        "selectedIconPath": "static/tab-icons/home-active.png",
        "text": "广场"
      },
      {
        "pagePath": "pages/discover/discover",
        "iconPath": "static/tab-icons/discover.png", 
        "selectedIconPath": "static/tab-icons/discover-active.png",
        "text": "发现"
      },
      {
        "pagePath": "pages/publish/publish",
        "iconPath": "static/tab-icons/publish.png",
        "selectedIconPath": "static/tab-icons/publish-active.png", 
        "text": "发布"
      },
      {
        "pagePath": "pages/message/message",
        "iconPath": "static/tab-icons/message.png",
        "selectedIconPath": "static/tab-icons/message-active.png",
        "text": "消息"
      },
      {
        "pagePath": "pages/profile/profile", 
        "iconPath": "static/tab-icons/profile.png",
        "selectedIconPath": "static/tab-icons/profile-active.png",
        "text": "我的"
      }
    ]
  }
}
```

## 开发规范

### 代码规范
1. 使用 TypeScript 严格模式
2. 组件名使用 PascalCase
3. 文件名使用 kebab-case
4. 常量使用 UPPER_SNAKE_CASE
5. 接口名以 I 开头

### 提交规范
- feat: 新功能
- fix: 修复
- docs: 文档
- style: 格式
- refactor: 重构
- test: 测试
- chore: 构建

### 测试策略
1. 单元测试覆盖率 > 80%
2. 接口测试全覆盖
3. E2E 测试覆盖核心流程

## 性能优化

### 前端优化
1. 图片懒加载
2. 虚拟列表
3. 路由懒加载
4. 组件按需引入
5. 缓存策略

### 后端优化
1. 数据库索引优化
2. Redis 缓存
3. CDN 加速
4. 接口防抖
5. 分页优化

## 安全策略

### 前端安全
1. 输入验证
2. XSS 防护
3. CSRF 防护
4. 敏感数据加密

### 后端安全
1. 接口鉴权
2. 频率限制
3. SQL 注入防护
4. 文件上传安全

## 监控与运维

### 监控指标
1. 应用性能监控 (APM)
2. 错误监控
3. 用户行为分析
4. 服务器监控

### 日志管理
1. 访问日志
2. 错误日志
3. 业务日志
4. 审计日志

## 部署策略

### 环境配置
- 开发环境 (dev)
- 测试环境 (test) 
- 预生产环境 (staging)
- 生产环境 (prod)

### 发布流程
1. 代码评审
2. 自动化测试
3. 构建打包
4. 灰度发布
5. 全量发布

## 风险控制

### 技术风险
1. 备份策略
2. 回滚方案
3. 限流熔断
4. 故障转移

### 业务风险
1. 内容审核
2. 反作弊
3. 用户举报
4. 应急响应

---

本文档将作为开发团队的指导文档，随着项目进展持续更新完善。