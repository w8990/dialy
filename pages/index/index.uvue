<template>
  <view class="index-page">
    <!-- Ëá™ÂÆö‰πâÂØºËà™Ê†è -->
    <view class="navbar">
      <text class="nav-title">ÂπøÂú∫</text>
      <view class="nav-tabs">
        <text 
          class="tab-item" 
          :class="{ active: currentTab === 'recommend' }"
          @tap="switchTab('recommend')"
        >
          Êé®Ëçê
        </text>
        <text 
          class="tab-item" 
          :class="{ active: currentTab === 'latest' }"
          @tap="switchTab('latest')"
        >
          ÊúÄÊñ∞
        </text>
      </view>
    </view>
    
    <!-- Âä®ÊÄÅÂàóË°® -->
    <scroll-view 
      class="content" 
      scroll-y="true"
      @scrolltolower="loadMorePosts"
      refresher-enabled="true"
      @refresherrefresh="refreshPosts"
      :refresher-triggered="isRefreshing"
    >
      <view class="post-list">
        <view 
          class="post-item" 
          v-for="post in postList" 
          :key="post.id"
          @tap="goToPostDetail(post.id)"
        >
          <!-- Áî®Êà∑‰ø°ÊÅØ -->
          <view class="user-info">
            <image class="avatar" :src="post.user.avatar" @tap.stop="goToUserProfile(post.user.uid)" />
            <view class="user-details">
              <text class="nickname">{{ post.user.nickname }}</text>
              <text class="post-time">{{ post.createdAt }}</text>
            </view>
            <view class="follow-btn" @tap.stop="toggleFollow(post.user)" v-if="!post.user.isFollowing">
              <text class="follow-text">ÂÖ≥Ê≥®</text>
            </view>
          </view>
          
          <!-- Âä®ÊÄÅÂÜÖÂÆπ -->
          <text class="content-text" v-if="post.content">{{ post.content }}</text>
          
          <!-- Â™í‰ΩìÂÜÖÂÆπ -->
          <view class="media-content" v-if="post.media && post.media.length > 0">
            <image 
              v-for="(media, index) in post.media.slice(0, 9)"
              :key="index"
              :src="media.url"
              class="media-item"
              :class="`media-${Math.min(post.media.length, 9)}`"
              @tap.stop="previewMedia(post.media, index)"
            />
          </view>
          
          <!-- ËØùÈ¢òÊ†áÁ≠æ -->
          <view class="topics" v-if="post.topics && post.topics.length > 0">
            <text 
              class="topic-tag" 
              v-for="topic in post.topics" 
              :key="topic"
              @tap.stop="goToTopic(topic)"
            >
              #{{ topic }}
            </text>
          </view>
          
          <!-- ‰ΩçÁΩÆ‰ø°ÊÅØ -->
          <view class="location" v-if="post.location">
            <text class="location-icon">üìç</text>
            <text class="location-text">{{ post.location.name }}</text>
          </view>
          
          <!-- ‰∫íÂä®ÊåâÈíÆ -->
          <view class="actions">
            <view class="action-btn" @tap.stop="toggleLike(post)">
              <text class="action-icon" :class="{ active: post.isLiked }">‚ù§Ô∏è</text>
              <text class="action-text">{{ post.likeCount || 0 }}</text>
            </view>
            <view class="action-btn" @tap.stop="goToPostDetail(post.id)">
              <text class="action-icon">üí¨</text>
              <text class="action-text">{{ post.commentCount || 0 }}</text>
            </view>
            <view class="action-btn" @tap.stop="sharePost(post)">
              <text class="action-icon">üì§</text>
              <text class="action-text">ÂàÜ‰∫´</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Âä†ËΩΩÊõ¥Â§ö -->
      <view class="load-more" v-if="hasMore">
        <text class="load-text">{{ isLoading ? 'Âä†ËΩΩ‰∏≠...' : '‰∏äÊãâÂä†ËΩΩÊõ¥Â§ö' }}</text>
      </view>
      
      <!-- Ê≤°ÊúâÊõ¥Â§ö -->
      <view class="no-more" v-if="!hasMore && postList.length > 0">
        <text class="no-more-text">Ê≤°ÊúâÊõ¥Â§öÂÜÖÂÆπ‰∫Ü</text>
      </view>
      
      <!-- Á©∫Áä∂ÊÄÅ -->
      <view class="empty-state" v-if="postList.length === 0 && !isLoading">
        <text class="empty-text">ÊöÇÊó†Âä®ÊÄÅ</text>
        <text class="empty-hint">Âø´ÂéªÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°Âä®ÊÄÅÂêßÔºÅ</text>
      </view>
    </scroll-view>
  </view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { Auth } from '../../utils/auth.uts'

// ÂΩìÂâçÊ†áÁ≠æ
const currentTab = ref('recommend')

// Âä®ÊÄÅÂàóË°®
const postList = ref<any[]>([])

// ÂàÜÈ°µÁõ∏ÂÖ≥
const currentPage = ref(1)
const hasMore = ref(true)
const isLoading = ref(false)
const isRefreshing = ref(false)

onMounted(() => {
  checkLoginStatus()
  loadPosts()
})

// Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
function checkLoginStatus() {
  if (!Auth.isLoggedIn()) {
    uni.reLaunch({
      url: '/pages/auth/login/login'
    })
  }
}

// ÂàáÊç¢Ê†áÁ≠æ
function switchTab(tab: string) {
  if (currentTab.value === tab) return
  
  currentTab.value = tab
  currentPage.value = 1
  postList.value = []
  hasMore.value = true
  loadPosts()
}

// Âä†ËΩΩÂä®ÊÄÅÂàóË°®
async function loadPosts(isRefresh: boolean = false) {
  if (isLoading.value && !isRefresh) return
  
  isLoading.value = true
  if (isRefresh) {
    isRefreshing.value = true
  }
  
  try {
    // TODO: Ë∞ÉÁî®APIËé∑ÂèñÂä®ÊÄÅÂàóË°®
    // Ê®°ÊãüÊï∞ÊçÆ
    const mockPosts = [
      {
        id: 'post1',
        content: '‰ªäÂ§©Â§©Ê∞îÁúü‰∏çÈîôÔºåÂíåÊúãÂèã‰∏ÄËµ∑ÂéªÂÖ¨Âõ≠ÊãçÁÖß‰∫ÜÔºÅüì∑',
        user: {
          uid: 'user1',
          nickname: 'ÊëÑÂΩ±Áà±Â•ΩËÄÖ',
          avatar: '/static/default-avatar.png',
          isFollowing: false
        },
        media: [
          { type: 'image', url: '/static/demo-image1.jpg' },
          { type: 'image', url: '/static/demo-image2.jpg' }
        ],
        topics: ['ÊëÑÂΩ±', 'ÁîüÊ¥ª'],
        location: {
          name: '‰∏≠Â§ÆÂÖ¨Âõ≠'
        },
        likeCount: 25,
        commentCount: 8,
        isLiked: false,
        createdAt: '2Â∞èÊó∂Ââç'
      },
      {
        id: 'post2',
        content: 'ÂàÜ‰∫´‰∏ÄÈÅì‰ªäÂ§©ÂÅöÁöÑÁæéÈ£üÔºåËâ≤È¶ôÂë≥‰ø±ÂÖ®ÔºÅüçù',
        user: {
          uid: 'user2',
          nickname: 'ÁæéÈ£üËææ‰∫∫',
          avatar: '/static/default-avatar.png',
          isFollowing: true
        },
        media: [
          { type: 'image', url: '/static/demo-food.jpg' }
        ],
        topics: ['ÁæéÈ£ü', 'ÁîüÊ¥ª'],
        likeCount: 42,
        commentCount: 15,
        isLiked: true,
        createdAt: '4Â∞èÊó∂Ââç'
      }
    ]
    
    setTimeout(() => {
      if (isRefresh) {
        postList.value = mockPosts
        currentPage.value = 1
      } else {
        postList.value.push(...mockPosts)
      }
      
      isLoading.value = false
      isRefreshing.value = false
      
      // Ê®°ÊãüÂàÜÈ°µ
      if (currentPage.value >= 3) {
        hasMore.value = false
      }
    }, 1000)
    
  } catch (error) {
    console.error('Âä†ËΩΩÂä®ÊÄÅÂ§±Ë¥•:', error)
    isLoading.value = false
    isRefreshing.value = false
    
    uni.showToast({
      title: 'Âä†ËΩΩÂ§±Ë¥•',
      icon: 'none'
    })
  }
}

// Âà∑Êñ∞Âä®ÊÄÅ
function refreshPosts() {
  loadPosts(true)
}

// Âä†ËΩΩÊõ¥Â§öÂä®ÊÄÅ
function loadMorePosts() {
  if (hasMore.value && !isLoading.value) {
    currentPage.value++
    loadPosts()
  }
}

// ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
function toggleLike(post: any) {
  post.isLiked = !post.isLiked
  if (post.isLiked) {
    post.likeCount++
  } else {
    post.likeCount--
  }
  
  // TODO: Ë∞ÉÁî®ÁÇπËµûAPI
  console.log('ÂàáÊç¢ÁÇπËµû:', post.id, post.isLiked)
}

// ÂàáÊç¢ÂÖ≥Ê≥®Áä∂ÊÄÅ
function toggleFollow(user: any) {
  user.isFollowing = !user.isFollowing
  
  // TODO: Ë∞ÉÁî®ÂÖ≥Ê≥®API
  console.log('ÂàáÊç¢ÂÖ≥Ê≥®:', user.uid, user.isFollowing)
  
  uni.showToast({
    title: user.isFollowing ? 'ÂÖ≥Ê≥®ÊàêÂäü' : 'ÂèñÊ∂àÂÖ≥Ê≥®',
    icon: 'success'
  })
}

// È¢ÑËßàÂ™í‰Ωì
function previewMedia(mediaList: any[], index: number) {
  const urls = mediaList.map(media => media.url)
  uni.previewImage({
    urls: urls,
    current: index
  })
}

// Ë∑≥ËΩ¨Âà∞Âä®ÊÄÅËØ¶ÊÉÖ
function goToPostDetail(postId: string) {
  uni.navigateTo({
    url: `/pages/post/detail/detail?id=${postId}`
  })
}

// Ë∑≥ËΩ¨Âà∞Áî®Êà∑‰∏ªÈ°µ
function goToUserProfile(uid: string) {
  uni.navigateTo({
    url: `/pages/user/profile/profile?uid=${uid}`
  })
}

// Ë∑≥ËΩ¨Âà∞ËØùÈ¢òÈ°µÈù¢
function goToTopic(topic: string) {
  uni.navigateTo({
    url: `/pages/topic/detail/detail?name=${topic}`
  })
}

// ÂàÜ‰∫´Âä®ÊÄÅ
function sharePost(post: any) {
  uni.showActionSheet({
    itemList: ['ÂàÜ‰∫´Âà∞ÂæÆ‰ø°', 'Â§çÂà∂ÈìæÊé•'],
    success: (res) => {
      if (res.tapIndex === 0) {
        // ÂàÜ‰∫´Âà∞ÂæÆ‰ø°
        console.log('ÂàÜ‰∫´Âà∞ÂæÆ‰ø°:', post.id)
      } else if (res.tapIndex === 1) {
        // Â§çÂà∂ÈìæÊé•
        uni.setClipboardData({
          data: `Âä®ÊÄÅÈìæÊé•: post/${post.id}`,
          success: () => {
            uni.showToast({
              title: 'ÈìæÊé•Â∑≤Â§çÂà∂',
              icon: 'success'
            })
          }
        })
      }
    }
  })
}
</script>

<style scoped>
.index-page {
  flex: 1;
  background-color: #f5f5f5;
}

.navbar {
  background-color: #ffffff;
  padding: 44px 20px 16px;
  border-bottom: 1px solid #eeeeee;
}

.nav-title {
  font-size: 20px;
  font-weight: bold;
  color: #333333;
  text-align: center;
  margin-bottom: 16px;
}

.nav-tabs {
  flex-direction: row;
  justify-content: center;
  gap: 40px;
}

.tab-item {
  font-size: 16px;
  color: #999999;
  padding: 8px 0;
}

.tab-item.active {
  color: #007AFF;
  font-weight: bold;
  border-bottom: 2px solid #007AFF;
}

.content {
  flex: 1;
}

.post-list {
  gap: 10px;
}

.post-item {
  background-color: #ffffff;
  padding: 16px;
}

.post-item:active {
  background-color: #f8f8f8;
}

.user-info {
  flex-direction: row;
  align-items: center;
  margin-bottom: 12px;
  gap: 12px;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 20px;
}

.user-details {
  flex: 1;
}

.nickname {
  font-size: 14px;
  font-weight: bold;
  color: #333333;
}

.post-time {
  font-size: 12px;
  color: #999999;
  margin-top: 2px;
}

.follow-btn {
  background-color: #007AFF;
  border-radius: 12px;
  padding: 6px 12px;
}

.follow-text {
  font-size: 12px;
  color: #ffffff;
}

.content-text {
  font-size: 15px;
  line-height: 1.4;
  color: #333333;
  margin-bottom: 12px;
}

.media-content {
  margin-bottom: 12px;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 4px;
}

.media-item {
  border-radius: 8px;
}

.media-1 {
  width: 200px;
  height: 200px;
}

.media-2 {
  width: calc(50% - 2px);
  height: 120px;
}

.media-3, .media-4, .media-5, .media-6, .media-7, .media-8, .media-9 {
  width: calc(33.33% - 3px);
  height: 100px;
}

.topics {
  flex-direction: row;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 8px;
}

.topic-tag {
  color: #007AFF;
  font-size: 14px;
}

.location {
  flex-direction: row;
  align-items: center;
  gap: 4px;
  margin-bottom: 12px;
}

.location-icon {
  font-size: 12px;
}

.location-text {
  font-size: 12px;
  color: #666666;
}

.actions {
  flex-direction: row;
  justify-content: space-around;
  padding: 8px 0;
  border-top: 1px solid #f5f5f5;
}

.action-btn {
  flex-direction: row;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
}

.action-icon {
  font-size: 16px;
  color: #666666;
}

.action-icon.active {
  color: #ff4444;
}

.action-text {
  font-size: 12px;
  color: #666666;
}

.load-more {
  align-items: center;
  padding: 20px;
}

.load-text {
  font-size: 14px;
  color: #999999;
}

.no-more {
  align-items: center;
  padding: 20px;
}

.no-more-text {
  font-size: 14px;
  color: #cccccc;
}

.empty-state {
  align-items: center;
  padding: 60px 20px;
  gap: 10px;
}

.empty-text {
  font-size: 18px;
  color: #999999;
}

.empty-hint {
  font-size: 14px;
  color: #cccccc;
}
</style>
