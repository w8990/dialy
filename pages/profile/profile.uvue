<template>
  <view class="profile-page">
    <scroll-view class="content" scroll-y="true">
      <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
      <view class="user-card">
        <view class="user-header">
          <image class="avatar" :src="userInfo.avatar" @tap="editAvatar" />
          <view class="user-info">
            <text class="nickname">{{ userInfo.nickname }}</text>
            <text class="signature">{{ userInfo.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹' }}</text>
            <view class="stats">
              <view class="stat-item">
                <text class="stat-number">{{ userInfo.postCount || 0 }}</text>
                <text class="stat-label">åŠ¨æ€</text>
              </view>
              <view class="stat-item">
                <text class="stat-number">{{ userInfo.followingCount || 0 }}</text>
                <text class="stat-label">å…³æ³¨</text>
              </view>
              <view class="stat-item">
                <text class="stat-number">{{ userInfo.followerCount || 0 }}</text>
                <text class="stat-label">ç²‰ä¸</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="user-actions">
          <view class="action-btn" @tap="editProfile">
            <text class="action-text">ç¼–è¾‘èµ„æ–™</text>
          </view>
        </view>
        
        <!-- å…´è¶£æ ‡ç­¾ -->
        <view class="interests" v-if="userInfo.interests && userInfo.interests.length > 0">
          <text class="interest-tag" v-for="interest in userInfo.interests" :key="interest">
            {{ interest }}
          </text>
        </view>
      </view>
      
      <!-- åŠŸèƒ½èœå• -->
      <view class="menu-section">
        <view class="menu-item" @tap="goToPage('/pages/profile/posts/posts')">
          <text class="menu-icon">ğŸ“</text>
          <text class="menu-text">æˆ‘çš„åŠ¨æ€</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="goToPage('/pages/profile/likes/likes')">
          <text class="menu-icon">â¤ï¸</text>
          <text class="menu-text">æˆ‘çš„ç‚¹èµ</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="goToPage('/pages/profile/follows/follows')">
          <text class="menu-icon">ğŸ‘¥</text>
          <text class="menu-text">æˆ‘çš„å…³æ³¨</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="goToPage('/pages/profile/visitors/visitors')">
          <text class="menu-icon">ğŸ‘€</text>
          <text class="menu-text">è®¿å®¢è®°å½•</text>
          <text class="menu-arrow">></text>
        </view>
      </view>
      
      <!-- è®¾ç½®èœå• -->
      <view class="menu-section">
        <view class="menu-item" @tap="goToPage('/pages/settings/privacy/privacy')">
          <text class="menu-icon">ğŸ”’</text>
          <text class="menu-text">éšç§è®¾ç½®</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="goToPage('/pages/settings/notification/notification')">
          <text class="menu-icon">ğŸ””</text>
          <text class="menu-text">é€šçŸ¥è®¾ç½®</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="goToPage('/pages/settings/about/about')">
          <text class="menu-icon">â„¹ï¸</text>
          <text class="menu-text">å…³äºæˆ‘ä»¬</text>
          <text class="menu-arrow">></text>
        </view>
        
        <view class="menu-item" @tap="showLogoutConfirm">
          <text class="menu-icon">ğŸšª</text>
          <text class="menu-text">é€€å‡ºç™»å½•</text>
          <text class="menu-arrow">></text>
        </view>
      </view>
    </scroll-view>
  </view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'
import { Auth } from '../../utils/auth.uts'

// ç”¨æˆ·ä¿¡æ¯
const userInfo = ref({
  uid: 'user123',
  nickname: 'æˆ‘çš„æ˜µç§°',
  avatar: '/static/default-avatar.png',
  signature: 'è¿™æ˜¯æˆ‘çš„ä¸ªæ€§ç­¾å',
  interests: ['æ‘„å½±', 'æ—…è¡Œ', 'ç¾é£Ÿ', 'éŸ³ä¹'],
  postCount: 26,
  followingCount: 128,
  followerCount: 89
})

onMounted(() => {
  loadUserInfo()
})

// åŠ è½½ç”¨æˆ·ä¿¡æ¯
function loadUserInfo() {
  const currentUser = Auth.getCurrentUser()
  if (currentUser) {
    userInfo.value = { ...userInfo.value, ...currentUser }
  }
}

// ç¼–è¾‘å¤´åƒ
function editAvatar() {
  uni.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    sourceType: ['camera', 'album'],
    success: (res) => {
      // TODO: ä¸Šä¼ å¤´åƒå¹¶æ›´æ–°
      console.log('é€‰æ‹©å¤´åƒ:', res.tempFilePaths[0])
    }
  })
}

// ç¼–è¾‘èµ„æ–™
function editProfile() {
  uni.navigateTo({
    url: '/pages/profile/edit/edit'
  })
}

// è·³è½¬åˆ°æŒ‡å®šé¡µé¢
function goToPage(url: string) {
  uni.navigateTo({
    url: url
  })
}

// æ˜¾ç¤ºé€€å‡ºç™»å½•ç¡®è®¤
function showLogoutConfirm() {
  uni.showModal({
    title: 'ç¡®è®¤é€€å‡º',
    content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
    success: (res) => {
      if (res.confirm) {
        logout()
      }
    }
  })
}

// é€€å‡ºç™»å½•
async function logout() {
  try {
    uni.showLoading({
      title: 'é€€å‡ºä¸­...'
    })
    
    await Auth.logout()
    
    uni.hideLoading()
    uni.showToast({
      title: 'å·²é€€å‡ºç™»å½•',
      icon: 'success'
    })
  } catch (error) {
    uni.hideLoading()
    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
  }
}
</script>

<style scoped>
.profile-page {
  flex: 1;
  background-color: #f5f5f5;
}

.content {
  flex: 1;
}

.user-card {
  background-color: #ffffff;
  padding: 30px 20px 20px;
  margin-bottom: 10px;
}

.user-header {
  flex-direction: row;
  gap: 16px;
  margin-bottom: 20px;
}

.avatar {
  width: 80px;
  height: 80px;
  border-radius: 40px;
}

.user-info {
  flex: 1;
  gap: 8px;
}

.nickname {
  font-size: 20px;
  font-weight: bold;
  color: #333333;
}

.signature {
  font-size: 14px;
  color: #666666;
  lines: 2;
}

.stats {
  flex-direction: row;
  gap: 20px;
  margin-top: 16px;
}

.stat-item {
  align-items: center;
  gap: 4px;
}

.stat-number {
  font-size: 18px;
  font-weight: bold;
  color: #333333;
}

.stat-label {
  font-size: 12px;
  color: #999999;
}

.user-actions {
  flex-direction: row;
  margin-bottom: 16px;
}

.action-btn {
  flex: 1;
  background-color: #007AFF;
  border-radius: 20px;
  padding: 10px 0;
  align-items: center;
}

.action-text {
  font-size: 14px;
  color: #ffffff;
  font-weight: bold;
}

.interests {
  flex-direction: row;
  flex-wrap: wrap;
  gap: 8px;
}

.interest-tag {
  padding: 6px 12px;
  background-color: #f0f0f0;
  border-radius: 16px;
  font-size: 12px;
  color: #666666;
}

.menu-section {
  background-color: #ffffff;
  margin-bottom: 10px;
}

.menu-item {
  flex-direction: row;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #f5f5f5;
  gap: 12px;
}

.menu-item:active {
  background-color: #f8f8f8;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-icon {
  font-size: 20px;
  width: 24px;
}

.menu-text {
  flex: 1;
  font-size: 16px;
  color: #333333;
}

.menu-arrow {
  font-size: 16px;
  color: #cccccc;
}
</style>