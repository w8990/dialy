<template>
  <view class="login-page">
    <view class="header">
      <text class="title">æ¬¢è¿æ¥åˆ°äº¤å‹ç¤¾åŒº</text>
      <text class="subtitle">å‘ç°èº«è¾¹æœ‰è¶£çš„äººå’Œäº‹</text>
    </view>
    
    <view class="login-form">
      <!-- æ‰‹æœºå·ç™»å½• -->
      <view class="login-section" v-if="loginType === 'phone'">
        <view class="input-group">
          <input 
            class="input" 
            type="number"
            v-model="phoneNumber"
            placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
            :maxlength="11"
          />
        </view>
        
        <view class="input-group">
          <input 
            class="input code-input" 
            type="number"
            v-model="smsCode"
            placeholder="è¯·è¾“å…¥éªŒè¯ç "
            :maxlength="6"
          />
          <view 
            class="send-code-btn" 
            :class="{ disabled: !canSendCode }"
            @tap="sendSmsCode"
          >
            <text class="send-code-text">{{ sendCodeText }}</text>
          </view>
        </view>
        
        <view class="login-btn" @tap="loginWithPhone">
          <text class="login-btn-text">ç™»å½•</text>
        </view>
      </view>
      
      <!-- ç¬¬ä¸‰æ–¹ç™»å½• -->
      <view class="third-party-login">
        <view class="divider">
          <view class="divider-line"></view>
          <text class="divider-text">å…¶ä»–ç™»å½•æ–¹å¼</text>
          <view class="divider-line"></view>
        </view>
        
        <view class="third-party-buttons">
          <view class="third-party-btn" @tap="loginWithWechat">
            <text class="third-party-icon">ğŸ’¬</text>
            <text class="third-party-text">å¾®ä¿¡ç™»å½•</text>
          </view>
          
          <!-- iOS æ˜¾ç¤º Apple ç™»å½• -->
          <view class="third-party-btn" @tap="loginWithApple" v-if="isIOS">
            <text class="third-party-icon">ğŸ</text>
            <text class="third-party-text">Appleç™»å½•</text>
          </view>
          
          <view class="third-party-btn" @tap="switchToPhone" v-if="loginType !== 'phone'">
            <text class="third-party-icon">ğŸ“±</text>
            <text class="third-party-text">æ‰‹æœºå·ç™»å½•</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ç”¨æˆ·åè®® -->
    <view class="agreement">
      <view class="agreement-check" @tap="toggleAgreement">
        <text class="checkbox" :class="{ checked: agreedToTerms }">{{ agreedToTerms ? 'âœ“' : '' }}</text>
        <text class="agreement-text">
          æˆ‘å·²é˜…è¯»å¹¶åŒæ„
          <text class="link" @tap="showTerms">ã€Šç”¨æˆ·åè®®ã€‹</text>
          å’Œ
          <text class="link" @tap="showPrivacy">ã€Šéšç§æ”¿ç­–ã€‹</text>
        </text>
      </view>
    </view>
  </view>
</template>

<script setup lang="uts">
import { ref, computed, onMounted } from 'vue'
import { Auth } from '../../../utils/auth.uts'

// ç™»å½•ç±»å‹
const loginType = ref<'phone' | 'third-party'>('phone')

// æ‰‹æœºå·ç™»å½•ç›¸å…³
const phoneNumber = ref('')
const smsCode = ref('')
const countdown = ref(0)
const agreedToTerms = ref(false)

// å¹³å°åˆ¤æ–­
const isIOS = ref(false)

// å‘é€éªŒè¯ç ç›¸å…³
const canSendCode = computed(() => {
  return Auth.validatePhone(phoneNumber.value) && countdown.value === 0
})

const sendCodeText = computed(() => {
  return countdown.value > 0 ? `${countdown.value}s` : 'è·å–éªŒè¯ç '
})

onMounted(() => {
  // æ£€æŸ¥å¹³å°
  const systemInfo = uni.getSystemInfoSync()
  isIOS.value = systemInfo.platform === 'ios'
  
  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  if (Auth.isLoggedIn()) {
    navigateToMain()
  }
})

// å‘é€çŸ­ä¿¡éªŒè¯ç 
async function sendSmsCode() {
  if (!canSendCode.value) {
    return
  }
  
  if (!Auth.validatePhone(phoneNumber.value)) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
      icon: 'none'
    })
    return
  }
  
  if (!agreedToTerms.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®',
      icon: 'none'
    })
    return
  }
  
  try {
    uni.showLoading({
      title: 'å‘é€ä¸­...'
    })
    
    await Auth.sendSmsCode(phoneNumber.value)
    
    uni.hideLoading()
    uni.showToast({
      title: 'éªŒè¯ç å·²å‘é€',
      icon: 'success'
    })
    
    // å¼€å§‹å€’è®¡æ—¶
    startCountdown()
    
  } catch (error: any) {
    uni.hideLoading()
    uni.showToast({
      title: error.message || 'å‘é€å¤±è´¥',
      icon: 'none'
    })
  }
}

// å¼€å§‹å€’è®¡æ—¶
function startCountdown() {
  countdown.value = 60
  const timer = setInterval(() => {
    countdown.value--
    if (countdown.value <= 0) {
      clearInterval(timer)
    }
  }, 1000)
}

// æ‰‹æœºå·ç™»å½•
async function loginWithPhone() {
  if (!Auth.validatePhone(phoneNumber.value)) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
      icon: 'none'
    })
    return
  }
  
  if (!smsCode.value || smsCode.value.length !== 6) {
    uni.showToast({
      title: 'è¯·è¾“å…¥6ä½éªŒè¯ç ',
      icon: 'none'
    })
    return
  }
  
  if (!agreedToTerms.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®',
      icon: 'none'
    })
    return
  }
  
  try {
    uni.showLoading({
      title: 'ç™»å½•ä¸­...'
    })
    
    const userInfo = await Auth.loginWithSms(phoneNumber.value, smsCode.value)
    
    uni.hideLoading()
    uni.showToast({
      title: 'ç™»å½•æˆåŠŸ',
      icon: 'success'
    })
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦å®Œå–„èµ„æ–™
    if (Auth.needCompleteProfile()) {
      navigateToCompleteProfile()
    } else {
      navigateToMain()
    }
    
  } catch (error: any) {
    uni.hideLoading()
    uni.showToast({
      title: error.message || 'ç™»å½•å¤±è´¥',
      icon: 'none'
    })
  }
}

// å¾®ä¿¡ç™»å½•
async function loginWithWechat() {
  if (!agreedToTerms.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®',
      icon: 'none'
    })
    return
  }
  
  try {
    uni.showLoading({
      title: 'ç™»å½•ä¸­...'
    })
    
    // è·å–å¾®ä¿¡æˆæƒç 
    uni.login({
      provider: 'weixin',
      success: async (loginRes) => {
        try {
          const userInfo = await Auth.loginWithWechat(loginRes.code, 'app')
          
          uni.hideLoading()
          uni.showToast({
            title: 'ç™»å½•æˆåŠŸ',
            icon: 'success'
          })
          
          if (Auth.needCompleteProfile()) {
            navigateToCompleteProfile()
          } else {
            navigateToMain()
          }
          
        } catch (error: any) {
          uni.hideLoading()
          uni.showToast({
            title: error.message || 'ç™»å½•å¤±è´¥',
            icon: 'none'
          })
        }
      },
      fail: () => {
        uni.hideLoading()
        uni.showToast({
          title: 'å¾®ä¿¡æˆæƒå¤±è´¥',
          icon: 'none'
        })
      }
    })
    
  } catch (error) {
    uni.hideLoading()
    uni.showToast({
      title: 'ç™»å½•å¤±è´¥',
      icon: 'none'
    })
  }
}

// Apple ç™»å½• (ä»…iOS)
function loginWithApple() {
  if (!isIOS.value) {
    return
  }
  
  if (!agreedToTerms.value) {
    uni.showToast({
      title: 'è¯·å…ˆåŒæ„ç”¨æˆ·åè®®',
      icon: 'none'
    })
    return
  }
  
  // TODO: å®ç° Apple ç™»å½•
  uni.showToast({
    title: 'Appleç™»å½•åŠŸèƒ½å¼€å‘ä¸­',
    icon: 'none'
  })
}

// åˆ‡æ¢åˆ°æ‰‹æœºå·ç™»å½•
function switchToPhone() {
  loginType.value = 'phone'
}

// åˆ‡æ¢åè®®åŒæ„çŠ¶æ€
function toggleAgreement() {
  agreedToTerms.value = !agreedToTerms.value
}

// æ˜¾ç¤ºç”¨æˆ·åè®®
function showTerms() {
  uni.navigateTo({
    url: '/pages/legal/terms/terms'
  })
}

// æ˜¾ç¤ºéšç§æ”¿ç­–
function showPrivacy() {
  uni.navigateTo({
    url: '/pages/legal/privacy/privacy'
  })
}

// å¯¼èˆªåˆ°å®Œå–„èµ„æ–™é¡µé¢
function navigateToCompleteProfile() {
  uni.redirectTo({
    url: '/pages/auth/complete/complete'
  })
}

// å¯¼èˆªåˆ°ä¸»é¡µ
function navigateToMain() {
  uni.switchTab({
    url: '/pages/index/index'
  })
}
</script>

<style scoped>
.login-page {
  flex: 1;
  background-color: #ffffff;
  padding: 40px 30px 30px;
}

.header {
  align-items: center;
  margin-bottom: 60px;
  margin-top: 80px;
}

.title {
  font-size: 24px;
  font-weight: bold;
  color: #333333;
  margin-bottom: 12px;
}

.subtitle {
  font-size: 16px;
  color: #666666;
}

.login-form {
  margin-bottom: 40px;
}

.login-section {
  gap: 20px;
}

.input-group {
  flex-direction: row;
  align-items: center;
  border-bottom: 1px solid #eeeeee;
  padding-bottom: 12px;
}

.input {
  flex: 1;
  font-size: 16px;
  color: #333333;
  background-color: transparent;
  border: none;
  padding: 12px 0;
}

.code-input {
  margin-right: 12px;
}

.send-code-btn {
  padding: 8px 16px;
  background-color: #007AFF;
  border-radius: 20px;
}

.send-code-btn.disabled {
  background-color: #cccccc;
}

.send-code-text {
  font-size: 14px;
  color: #ffffff;
}

.login-btn {
  background-color: #007AFF;
  border-radius: 25px;
  padding: 16px 0;
  align-items: center;
  margin-top: 30px;
}

.login-btn-text {
  font-size: 16px;
  font-weight: bold;
  color: #ffffff;
}

.third-party-login {
  margin-top: 40px;
}

.divider {
  flex-direction: row;
  align-items: center;
  gap: 16px;
  margin-bottom: 30px;
}

.divider-line {
  flex: 1;
  height: 1px;
  background-color: #eeeeee;
}

.divider-text {
  font-size: 14px;
  color: #999999;
}

.third-party-buttons {
  gap: 16px;
}

.third-party-btn {
  flex-direction: row;
  align-items: center;
  justify-content: center;
  padding: 14px 0;
  border: 1px solid #eeeeee;
  border-radius: 25px;
  gap: 8px;
}

.third-party-btn:active {
  background-color: #f8f8f8;
}

.third-party-icon {
  font-size: 20px;
}

.third-party-text {
  font-size: 16px;
  color: #333333;
}

.agreement {
  position: absolute;
  bottom: 30px;
  left: 30px;
  right: 30px;
}

.agreement-check {
  flex-direction: row;
  align-items: flex-start;
  gap: 8px;
}

.checkbox {
  width: 16px;
  height: 16px;
  border: 1px solid #cccccc;
  border-radius: 3px;
  text-align: center;
  line-height: 14px;
  font-size: 12px;
  color: #ffffff;
}

.checkbox.checked {
  background-color: #007AFF;
  border-color: #007AFF;
}

.agreement-text {
  flex: 1;
  font-size: 12px;
  color: #999999;
  line-height: 1.4;
}

.link {
  color: #007AFF;
}
</style>