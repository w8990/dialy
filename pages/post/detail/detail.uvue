<template>
  <view class="post-detail-page">
    <scroll-view class="content" scroll-y="true">
      <!-- Âä®ÊÄÅÂÜÖÂÆπ -->
      <view class="post-content" v-if="postData">
        <view class="user-info">
          <image class="avatar" :src="postData.user.avatar" />
          <view class="user-details">
            <text class="nickname">{{ postData.user.nickname }}</text>
            <text class="post-time">{{ postData.createdAt }}</text>
          </view>
          <view class="more-btn" @tap="showMoreOptions">‚ãØ</view>
        </view>
        
        <text class="content-text" v-if="postData.content">{{ postData.content }}</text>
        
        <!-- Â™í‰ΩìÂÜÖÂÆπ -->
        <view class="media-content" v-if="postData.media && postData.media.length > 0">
          <view class="media-grid">
            <image 
              v-for="(media, index) in postData.media"
              :key="index"
              :src="media.url"
              class="media-item"
              @tap="previewMedia(index)"
            />
          </view>
        </view>
        
        <!-- ËØùÈ¢òÊ†áÁ≠æ -->
        <view class="topics" v-if="postData.topics && postData.topics.length > 0">
          <text 
            class="topic-tag" 
            v-for="topic in postData.topics" 
            :key="topic"
            @tap="goToTopic(topic)"
          >
            #{{ topic }}
          </text>
        </view>
        
        <!-- ‰ΩçÁΩÆ‰ø°ÊÅØ -->
        <view class="location" v-if="postData.location">
          <text class="location-icon">üìç</text>
          <text class="location-text">{{ postData.location.name }}</text>
        </view>
        
        <!-- ‰∫íÂä®ÊåâÈíÆ -->
        <view class="actions">
          <view class="action-btn" @tap="toggleLike">
            <text class="action-icon" :class="{ active: postData.isLiked }">‚ù§Ô∏è</text>
            <text class="action-text">{{ postData.likeCount || 0 }}</text>
          </view>
          <view class="action-btn" @tap="focusCommentInput">
            <text class="action-icon">üí¨</text>
            <text class="action-text">{{ postData.commentCount || 0 }}</text>
          </view>
          <view class="action-btn" @tap="sharePost">
            <text class="action-icon">üì§</text>
            <text class="action-text">ÂàÜ‰∫´</text>
          </view>
        </view>
      </view>
      
      <!-- ËØÑËÆ∫ÂàóË°® -->
      <view class="comments-section">
        <view class="section-title">
          <text class="title-text">ËØÑËÆ∫ {{ comments.length }}</text>
        </view>
        
        <view class="comment-list">
          <view class="comment-item" v-for="comment in comments" :key="comment.id">
            <image class="comment-avatar" :src="comment.user.avatar" />
            <view class="comment-content">
              <text class="comment-user">{{ comment.user.nickname }}</text>
              <text class="comment-text">{{ comment.content }}</text>
              <view class="comment-actions">
                <text class="comment-time">{{ comment.createdAt }}</text>
                <text class="comment-reply" @tap="replyToComment(comment)">ÂõûÂ§ç</text>
              </view>
              
              <!-- ÂõûÂ§çÂàóË°® -->
              <view class="replies" v-if="comment.replies && comment.replies.length > 0">
                <view class="reply-item" v-for="reply in comment.replies" :key="reply.id">
                  <text class="reply-user">{{ reply.user.nickname }}</text>
                  <text class="reply-text">{{ reply.content }}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- Á©∫Áä∂ÊÄÅ -->
        <view class="empty-comments" v-if="comments.length === 0">
          <text class="empty-text">ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèëÂêßÔºÅ</text>
        </view>
      </view>
    </scroll-view>
    
    <!-- ËØÑËÆ∫ËæìÂÖ•Ê°Ü -->
    <view class="comment-input-section">
      <view class="input-container">
        <input 
          class="comment-input" 
          v-model="commentText"
          placeholder="ËØ¥ÁÇπ‰ªÄ‰πà..."
          :focus="inputFocused"
          @blur="inputFocused = false"
        />
        <view class="send-btn" @tap="sendComment" :class="{ active: commentText.trim() }">
          <text class="send-text">ÂèëÈÄÅ</text>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup lang="uts">
import { ref, onMounted } from 'vue'

// Âä®ÊÄÅÊï∞ÊçÆ
const postData = ref<any>(null)

// ËØÑËÆ∫Áõ∏ÂÖ≥
const comments = ref<any[]>([])
const commentText = ref('')
const inputFocused = ref(false)

// ÂõûÂ§çÁõ∏ÂÖ≥
const replyToUser = ref<any>(null)

onMounted(() => {
  loadPostDetail()
  loadComments()
})

// Âä†ËΩΩÂä®ÊÄÅËØ¶ÊÉÖ
function loadPostDetail() {
  // TODO: ‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑ÂèñpostIdÂπ∂Ë∞ÉÁî®API
  // Ê®°ÊãüÊï∞ÊçÆ
  postData.value = {
    id: 'post123',
    content: '‰ªäÂ§©Â§©Ê∞îÁúü‰∏çÈîôÔºåÂíåÊúãÂèã‰∏ÄËµ∑ÂéªÂÖ¨Âõ≠ÊãçÁÖß‰∫ÜÔºÅÂàÜ‰∫´Âá†Âº†ÁæéÁÖßÁªôÂ§ßÂÆ∂ÁúãÁúã„ÄÇ',
    user: {
      uid: 'user123',
      nickname: 'ÊëÑÂΩ±Áà±Â•ΩËÄÖ',
      avatar: '/static/default-avatar.png'
    },
    media: [
      { type: 'image', url: '/static/demo-image1.jpg' },
      { type: 'image', url: '/static/demo-image2.jpg' }
    ],
    topics: ['ÊëÑÂΩ±', 'ÁîüÊ¥ª'],
    location: {
      name: '‰∏≠Â§ÆÂÖ¨Âõ≠'
    },
    likeCount: 25,
    commentCount: 8,
    isLiked: false,
    createdAt: '2Â∞èÊó∂Ââç'
  }
}

// Âä†ËΩΩËØÑËÆ∫ÂàóË°®
function loadComments() {
  // TODO: Ë∞ÉÁî®APIËé∑ÂèñËØÑËÆ∫
  comments.value = [
    {
      id: 'comment1',
      content: 'ÊãçÂæóÁúüÂ•ΩÁúãÔºÅ',
      user: {
        nickname: 'Â∞èÊòé',
        avatar: '/static/default-avatar.png'
      },
      createdAt: '1Â∞èÊó∂Ââç',
      replies: [
        {
          id: 'reply1',
          content: 'Ë∞¢Ë∞¢Â§∏Â•ñÔºÅ',
          user: {
            nickname: 'ÊëÑÂΩ±Áà±Â•ΩËÄÖ',
            avatar: '/static/default-avatar.png'
          }
        }
      ]
    },
    {
      id: 'comment2',
      content: 'Ëøô‰∏™ËßíÂ∫¶ÂæàÊ£íÔºåËØ∑ÈóÆÊòØÁî®‰ªÄ‰πàÁõ∏Êú∫ÊãçÁöÑÔºü',
      user: {
        nickname: 'Â∞èÁ∫¢',
        avatar: '/static/default-avatar.png'
      },
      createdAt: '30ÂàÜÈíüÂâç'
    }
  ]
}

// ÂàáÊç¢ÁÇπËµûÁä∂ÊÄÅ
function toggleLike() {
  if (!postData.value) return
  
  postData.value.isLiked = !postData.value.isLiked
  if (postData.value.isLiked) {
    postData.value.likeCount++
  } else {
    postData.value.likeCount--
  }
  
  // TODO: Ë∞ÉÁî®ÁÇπËµûAPI
}

// ËÅöÁÑ¶ËØÑËÆ∫ËæìÂÖ•Ê°Ü
function focusCommentInput() {
  inputFocused.value = true
}

// ÂèëÈÄÅËØÑËÆ∫
function sendComment() {
  if (!commentText.value.trim()) {
    return
  }
  
  // TODO: Ë∞ÉÁî®ÂèëÈÄÅËØÑËÆ∫API
  const newComment = {
    id: 'comment' + Date.now(),
    content: commentText.value,
    user: {
      nickname: 'ÂΩìÂâçÁî®Êà∑',
      avatar: '/static/default-avatar.png'
    },
    createdAt: 'ÂàöÂàö'
  }
  
  comments.value.unshift(newComment)
  commentText.value = ''
  inputFocused.value = false
  
  // Êõ¥Êñ∞ËØÑËÆ∫Êï∞
  if (postData.value) {
    postData.value.commentCount++
  }
  
  uni.showToast({
    title: 'ËØÑËÆ∫ÊàêÂäü',
    icon: 'success'
  })
}

// ÂõûÂ§çËØÑËÆ∫
function replyToComment(comment: any) {
  replyToUser.value = comment.user
  commentText.value = `ÂõûÂ§ç @${comment.user.nickname}: `
  inputFocused.value = true
}

// È¢ÑËßàÂ™í‰Ωì
function previewMedia(index: number) {
  if (!postData.value?.media) return
  
  const urls = postData.value.media.map((media: any) => media.url)
  uni.previewImage({
    urls: urls,
    current: index
  })
}

// Ë∑≥ËΩ¨Âà∞ËØùÈ¢òÈ°µÈù¢
function goToTopic(topic: string) {
  uni.navigateTo({
    url: `/pages/topic/detail/detail?name=${topic}`
  })
}

// ÂàÜ‰∫´Âä®ÊÄÅ
function sharePost() {
  uni.showActionSheet({
    itemList: ['ÂàÜ‰∫´Âà∞ÂæÆ‰ø°', 'Â§çÂà∂ÈìæÊé•'],
    success: (res) => {
      if (res.tapIndex === 0) {
        // ÂàÜ‰∫´Âà∞ÂæÆ‰ø°
      } else if (res.tapIndex === 1) {
        // Â§çÂà∂ÈìæÊé•
        uni.setClipboardData({
          data: `Âä®ÊÄÅÈìæÊé•: post/${postData.value?.id}`,
          success: () => {
            uni.showToast({
              title: 'ÈìæÊé•Â∑≤Â§çÂà∂',
              icon: 'success'
            })
          }
        })
      }
    }
  })
}

// ÊòæÁ§∫Êõ¥Â§öÈÄâÈ°π
function showMoreOptions() {
  const options = ['‰∏æÊä•', 'ÊãâÈªëÁî®Êà∑']
  
  uni.showActionSheet({
    itemList: options,
    success: (res) => {
      if (res.tapIndex === 0) {
        // ‰∏æÊä•
        reportPost()
      } else if (res.tapIndex === 1) {
        // ÊãâÈªëÁî®Êà∑
        blockUser()
      }
    }
  })
}

// ‰∏æÊä•Âä®ÊÄÅ
function reportPost() {
  uni.showModal({
    title: '‰∏æÊä•',
    content: 'Á°ÆÂÆöË¶Å‰∏æÊä•ËøôÊù°Âä®ÊÄÅÂêóÔºü',
    success: (res) => {
      if (res.confirm) {
        // TODO: Ë∞ÉÁî®‰∏æÊä•API
        uni.showToast({
          title: '‰∏æÊä•ÊàêÂäü',
          icon: 'success'
        })
      }
    }
  })
}

// ÊãâÈªëÁî®Êà∑
function blockUser() {
  uni.showModal({
    title: 'ÊãâÈªëÁî®Êà∑',
    content: 'Á°ÆÂÆöË¶ÅÊãâÈªëËøô‰∏™Áî®Êà∑ÂêóÔºü',
    success: (res) => {
      if (res.confirm) {
        // TODO: Ë∞ÉÁî®ÊãâÈªëAPI
        uni.showToast({
          title: 'Â∑≤ÊãâÈªëËØ•Áî®Êà∑',
          icon: 'success'
        })
      }
    }
  })
}
</script>

<style scoped>
.post-detail-page {
  flex: 1;
  background-color: #f5f5f5;
}

.content {
  flex: 1;
  margin-bottom: 60px;
}

.post-content {
  background-color: #ffffff;
  padding: 16px;
  margin-bottom: 10px;
}

.user-info {
  flex-direction: row;
  align-items: center;
  margin-bottom: 12px;
  gap: 10px;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 20px;
}

.user-details {
  flex: 1;
}

.nickname {
  font-size: 14px;
  font-weight: bold;
  color: #333333;
}

.post-time {
  font-size: 12px;
  color: #999999;
  margin-top: 2px;
}

.more-btn {
  padding: 4px 8px;
  color: #999999;
}

.content-text {
  font-size: 16px;
  line-height: 1.5;
  color: #333333;
  margin-bottom: 12px;
}

.media-content {
  margin-bottom: 12px;
}

.media-grid {
  flex-direction: row;
  flex-wrap: wrap;
  gap: 4px;
}

.media-item {
  width: 120px;
  height: 120px;
  border-radius: 8px;
}

.topics {
  flex-direction: row;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

.topic-tag {
  color: #007AFF;
  font-size: 14px;
}

.location {
  flex-direction: row;
  align-items: center;
  gap: 4px;
  margin-bottom: 12px;
}

.location-icon {
  font-size: 12px;
}

.location-text {
  font-size: 12px;
  color: #666666;
}

.actions {
  flex-direction: row;
  justify-content: space-around;
  padding: 12px 0;
  border-top: 1px solid #f5f5f5;
}

.action-btn {
  flex-direction: row;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
}

.action-icon {
  font-size: 16px;
  color: #666666;
}

.action-icon.active {
  color: #ff4444;
}

.action-text {
  font-size: 12px;
  color: #666666;
}

.comments-section {
  background-color: #ffffff;
  padding: 16px;
}

.section-title {
  margin-bottom: 16px;
}

.title-text {
  font-size: 16px;
  font-weight: bold;
  color: #333333;
}

.comment-list {
  gap: 16px;
}

.comment-item {
  flex-direction: row;
  gap: 10px;
}

.comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 16px;
}

.comment-content {
  flex: 1;
}

.comment-user {
  font-size: 12px;
  font-weight: bold;
  color: #333333;
  margin-bottom: 4px;
}

.comment-text {
  font-size: 14px;
  color: #333333;
  line-height: 1.4;
  margin-bottom: 8px;
}

.comment-actions {
  flex-direction: row;
  gap: 16px;
}

.comment-time {
  font-size: 12px;
  color: #999999;
}

.comment-reply {
  font-size: 12px;
  color: #007AFF;
}

.replies {
  margin-top: 8px;
  padding-left: 12px;
  border-left: 2px solid #f5f5f5;
  gap: 4px;
}

.reply-item {
  flex-direction: row;
  gap: 4px;
}

.reply-user {
  font-size: 12px;
  color: #007AFF;
}

.reply-text {
  flex: 1;
  font-size: 12px;
  color: #666666;
}

.empty-comments {
  align-items: center;
  padding: 40px 0;
}

.empty-text {
  font-size: 14px;
  color: #999999;
}

.comment-input-section {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: #ffffff;
  border-top: 1px solid #eeeeee;
  padding: 8px 16px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

.input-container {
  flex-direction: row;
  align-items: center;
  gap: 12px;
}

.comment-input {
  flex: 1;
  background-color: #f8f8f8;
  border-radius: 20px;
  padding: 10px 16px;
  font-size: 14px;
  max-height: 80px;
}

.send-btn {
  padding: 8px 16px;
  border-radius: 20px;
  background-color: #cccccc;
}

.send-btn.active {
  background-color: #007AFF;
}

.send-text {
  font-size: 14px;
  color: #ffffff;
}
</style>